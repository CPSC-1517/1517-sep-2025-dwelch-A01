@page "/tablepaging"
<PageTitle>Table Query Paging</PageTitle>
@rendermode InteractiveServer

<!-- Additional namespaces-->
@using WestWindSystem.BLL;
@using WestWindSystem.Entities;

<!--

Additional package setup

you will need to add the NuGet package Blazor.BootStrap by vikram reddy (do first)
you will need to add a using statement
using BlazorBootstrap
-->
@using BlazorBootstrap;

<h1>Shipping Query (using paging)</h1>
<cite>... non primary key filter search</cite>
<br/><br/>
@if (feedBackMsg.Length > 0)
{
    <div class="alert alert-info">
        <p>@feedBackMsg</p>
    </div>
}

@if (errorMsgs.Count > 0)
{
    <div class="alert alert-danger">
        <p>Please fix the following issues:</p>
        <ul>
            @foreach (var error in errorMsgs)
            {
                <li>@error</li>
            }
        </ul>
    </div>
}

<div class="row">
    <div class="col-md-3">
        <label for="yearid">Enter a year:</label>&nbsp;&nbsp;
        <input id="yearid" type="number" @bind="yeararg"
               placeholder="enter year" style="width:100px;" />
        <br/><br/>
        <label for="monthid">Enter a month:</label>&nbsp;&nbsp;
        <input id="monthid" type="number" @bind="montharg"
               placeholder="enter month" style="width:100px;" />
        <br /><br />

        <button type="submit" @onclick="GetShipments"
                class="btn btn-outline-primary rounded-pill"
                style="width:170px">
            Fetch Shipments
        </button>
    </div>
    <div class="col-md-8">
        @if (shipmentList == null)
        {
            <!-- a -->
            <p>Enter a year and month for the search</p>
        }
        else if (shipmentList.Count == 0)
        {
            <!-- b -->
            <p>No data found for the year @yeararg month @montharg.</p>
        }
        else
        {
            //table
            //to reduce the number of data rows being displayed there are two techniques
            //a) pagination
            //b) scrolling

            //this example uses the Bootstrap Pagination tag:
            //Required
            //      total records possibly returned: totalItems
            //      total required pages depending on totalItems: GetTotalPage()
            //      current page number: currentPageNumber
            //      items per page: itemsPerPage
            //      collection to hold records that will be displayed

            <table class="table table-striped">
                <thead >
                    <tr>
                        <th>ID</th>
                        <th>Order</th>
                        <th>Date</th>
                        <th>Shipper</th>
                        @* align="right" does not work on the column header*@
                        <th>Freight $</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in shipmentList)
                    {
                        //the shipment record has a field called ShipVia which is foreign key (1, 2, 3, etc)
                        //displaying that is meaningless to someone reading the data unless they were familiar with
                        //      the pkey value associated with each company
                        //solution: display the company name
                        //Problem: the name is in a different table

                        //If you look at the entities, records with fields used in sql scheme relationships
                        //      have virtual navigational properties (see bottom of entity)
                        //These properties allow you to have access to data in the related table

                        //How to use

                        //When you use the property just treat it as the name of an object so accessing the
                        //      desired field in the related table just needs the dot (.) operator
                        //In this example, the property is ShipViaNavigation which points to the Shippers table
                        //      and the desired field from the Shippers table was CompanyName

                        <tr>
                            <td>@item.ShipmentID</td>
                            <td>@item.OrderID</td>
                            <td>@item.ShippedDate.ToString("MMM dd, yyyy")</td>

                            

                            @* <td>@item.ShipVia</td> *@
                            @* child (shipment) is accessing the parent (shipper)
                                using the navigational property in Shippment
                               the navigational property works "like a join"
                               this allows access to the relation instance to shipment
                               thus one can access the properties of Shipper

                            *@
                            <td>@item.ShipViaNavigation.CompanyName</td>
                            <td align="right">@(string.Format("{0:#,##0.00}",item.FreightCharge))</td>
                        </tr>
                    }
                </tbody>
            </table>

            <!--
                  this tag will display 5 page numbers at a time
                  it contains the usual First Previous page numbers Next Last layout
                  HOWEVER, it does not adjust the page numbers to have a continuous
                  display of pages like  4 5 6 7 8
                  instead it is 1 2 3 4 5 then 6 7 8 9 10 then 11 12 ..
                  but if you look at the first/last number there is a small space
                    near the top of the display that is empty and can be clicked
                    as if it is the expected ... normally displayed



                  remember this control tag is TOTALLY independent of the table
                  -->
              <Pagination ActivePageNumber="currentPageNumber"
                          TotalPages="GetTotalPages()"
                          PageChanged="OnPageChanged">
              </Pagination>

        }
    
    </div>
</div>
@code {
    private string feedBackMsg = "";
    private List<string> errorMsgs = new();

    // bind variables
    private int yeararg = 0;
    private int montharg = 0;
    private List<Shipment> shipmentList = null;
    private List<Shipper> shipperList = null;

    //injected services
    [Inject]
    public ShipmentServices _shipmentServices { get; set; }

    //is required to obtain the shipper list needed by the table
    [Inject]
    public ShipperServices _shipperServices { get; set; }

    //pagination variables
    private int totalitems = 0;
    private int currentPageNumber = 0;
    private int itemsPerPage = 5; //is a developer decision

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // default year and month
        yeararg = DateTime.Today.Year;
        montharg = DateTime.Today.Month;

        //there are two techniques to allow the use of navigational properties on your page
        //      a) bring in a dataset of the table to which you are attempting to navigate
        //      b) use the .Include method on the query itself (see Shipment query for this technique in BLL ShipmentServices)

        // Technique (a)
        // this data set is needed to handle the navigation reference used on the table data cell
        //           to display the shipper company name
        // no other coding is needed, the system will match up the dataset to the usage in the table above
        //shipperList = _shipperServices.Shipper_GetAll();
    }

    // button events
    public void GetShipments()
    {
        //clear old messages, old data
        feedBackMsg ="";
        errorMsgs.Clear();
        shipmentList = null;

        //for Pagination, you will also need to reset the current page number to the first page -> 1;
        currentPageNumber = 1;

        //validate incoming argment values
        //definitely valid if the user can enter data values
        //optional if the data is from a list produced by
        //  the program of a valid collection. Usually done
        //  if there is a prompt on the selection

        if (yeararg < 1950 || yeararg > DateTime.Today.Year)
        {
            errorMsgs.Add($" Invalid year {yeararg}. Year must be between 1950 and today.");
        }
        if (montharg < 1 || montharg > 12)
        {
            errorMsgs.Add($" Invalid month {montharg}. Month must be between 1 and 12.");
        }

        // continue processing query???
        if(errorMsgs.Count == 0)
        {
            //assuming data is valid
            //get the data (consume a service)

            //since we are leaving the web app for another project (app)
            //  AND that app could possibly throw an exception
            //  consumption should be placed in a try/catch
            try
            {
                //Pagination
                //need to call a service for
                //    get the total number of records from on the database
                //    get only the number of records needed to display on the current page
                //          which is the first page for the query parameters
                totalitems = _shipmentServices.Shipment_GetByYearandMonthCount(yeararg, montharg);

                //consume service

                //obtaining your query contain when NOT using paging
                //shipmentList = _shipmentServices.Shipment_GetByYearandMonth(yeararg,montharg);

                //obtaining your query content when using paging
                //2 additional argument values need to be included
                //  a) the currentPageNumber
                //  b) the items per page
                //this query call with return ONLY the rows to be displayed for the indicated page (currentPageNumber)
                shipmentList = _shipmentServices.Shipment_GetByYearandMonthPaging(yeararg, montharg,
                                                    currentPageNumber, itemsPerPage);
            }
            catch (Exception ex)
            {
                errorMsgs.Add($"System Error: {ex.Message}");
            }
        }
    }

    #region Pagination

    private int GetTotalPages()
    {
        //calculation needed on each query

        //totalitems is obtained by a query
        //itemsPerPage was a developer decision

        int totalPages = (totalitems + itemsPerPage - 1) / itemsPerPage;
        return totalPages;

    }

    private void OnPageChanged(int newPageNumber)
    {
        //the incoming value for your parameter will be supplied by the Pagination control
        //remember to update the current page number to the newly selected page number
        currentPageNumber = newPageNumber;

        //retrieve the "page" by requerying your service against the database
        //parameters required
        //  query value parameter(s)
        //  itemPerPage
        //  currentPageNumber

        //REMEMBER: the query returns ONLY the rows for the current page.
        shipmentList = _shipmentServices.Shipment_GetByYearandMonthPaging(yeararg, montharg,
                                                   currentPageNumber, itemsPerPage);
    }
    #endregion
}
